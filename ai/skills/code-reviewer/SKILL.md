---
name: code-reviewer
description: Review code for architecture, quality, Android specifics, security, and performance following project standards. Use when reviewing code, checking PRs, analyzing code quality, or when user mentions 'review', 'code review', 'レビュー', '审査', 'コードレビュー', 'check code'.
allowed-tools: Read, Bash, Grep, Glob
---

# Code Reviewer

このスキルはプロジェクトの規約に従ってコードレビューを実施します。

## レビュー実行手順

### 1. 変更ファイルの特定
```bash
# 変更されたファイル一覧
git status

# 差分確認
git diff
```

### 2. 関連ファイルの読み込み
```bash
# Readツールで変更ファイルを読み込む
# 依存クラスも確認
```

### 3. チェックリストに従ってレビュー

## アーキテクチャレビュー

### 設計原則遵守
- [ ] **単一責任原則**: 各クラスが単一の責任を持っているか
- [ ] **依存関係逆転**: 抽象に依存し、具象に依存していないか
- [ ] **開放閉鎖原則**: 拡張に対して開放的、修正に対して閉鎖的か
- [ ] **レイヤー分離**: 各レイヤーの責任が適切に分離されているか

### Clean Architecture準拠
- [ ] **データ層**: Repository、DataSource、APIクライアントが適切に分離されているか
- [ ] **ドメイン層**: ビジネスロジックがUIやフレームワークに依存していないか
- [ ] **プレゼンテーション層**: ViewModelがAndroid固有のクラスに依存していないか
- [ ] **UI層**: Viewがビジネスロジックを持っていないか

## コード品質レビュー

### 命名規則
- [ ] **変数名**: 意味が明確で一貫性があるか
- [ ] **メソッド名**: 動詞で始まり、処理内容が分かるか
- [ ] **クラス名**: 名詞で、役割が明確か
- [ ] **定数名**: UPPER_SNAKE_CASEで統一されているか

### コードフォーマット
- [ ] **インデント**: 一貫したインデント（スペース4つ）が使用されているか
- [ ] **改行**: 適切な位置で改行されているか（行が長すぎないか）
- [ ] **空白**: 演算子の前後に適切な空白があるか
- [ ] **括弧**: 開き括弧と閉じ括弧の位置が正しいか
- [ ] **トレーリングカンマ**: 複数行の引数やパラメータにトレーリングカンマがあるか
- [ ] **不要な空白**: 行末や空行に不要な空白がないか
- [ ] **インポート順序**: インポート文が適切に整理されているか
- [ ] **Kotlin Style Guide**: Kotlinの公式スタイルガイドに準拠しているか

### コメント・ドキュメンテーション
- [ ] **コメント言語**: 英語または日本語のみ（❌中国語禁止）
- [ ] **必要最小限**: 自明でない処理のみコメントがあるか
- [ ] **KDoc**: 公開メソッドに適切なドキュメントがあるか
- [ ] **TODOコメント**: 不要なTODOが残っていないか
- [ ] **コメント・実装一致**: コメントと実際の実装内容が一致しているか

### エラーハンドリング
- [ ] **例外処理**: 適切にtry-catchが使用されているか
- [ ] **ログ出力**: エラー時に適切なログが出力されるか
- [ ] **ユーザー体験**: エラー時のUI表示が適切か
- [ ] **リソースクリーンアップ**: finallyブロックまたはuseパターンでリソースが解放されているか

## Android固有レビュー

### ライフサイクル管理
- [ ] **Activity/Fragment**: ライフサイクルメソッドが適切に実装されているか
- [ ] **ViewModel**: ViewModelScopeが適切に使用されているか
- [ ] **Observer**: LiveData/StateFlowの購読が適切に管理されているか
- [ ] **バックグラウンド処理**: メインスレッドをブロックしていないか

### リソース管理
- [ ] **Realm**: .use{}パターンが使用されているか（🚨CRITICAL）
- [ ] **ストリーム**: RxJavaストリームが適切にdisposeされているか
- [ ] **ファイル**: FileInputStreamなどが適切にcloseされているか
- [ ] **メモリリーク**: WeakReferenceが必要な箇所で使用されているか

### UI/UX
- [ ] **レスポンシブデザイン**: 様々な画面サイズに対応しているか
- [ ] **ダークモード**: ダークモード対応が適切に実装されているか
- [ ] **アクセシビリティ**: contentDescriptionなどが設定されているか
- [ ] **パフォーマンス**: スクロール性能が適切か

### 非推奨API・Lint警告
- [ ] **Deprecated API**: 非推奨のAPIを使用していないか（@Deprecatedアノテーションがある場合は代替手段を使用）
- [ ] **古いAPI**: 新しい推奨APIがある場合は移行しているか（例: launchWhenResumed → repeatOnLifecycle）
- [ ] **Lint警告**: Android Lintの警告が残っていないか
- [ ] **未使用コード**: 使用されていないimport、変数、メソッドがないか
- [ ] **ハードコーディング**: strings.xmlを使用すべき文字列がハードコーディングされていないか
- [ ] **リソースID**: リソースIDの直接指定ではなく、R.xxxを使用しているか
- [ ] **API Level**: MinSDK以上のAPIのみを使用しているか（@RequiresApiで適切にチェック）

## セキュリティレビュー

### データ保護
- [ ] **機密情報**: ログにパスワードなどが出力されていないか（🚨CRITICAL）
- [ ] **暗号化**: 必要なデータが適切に暗号化されているか
- [ ] **キーストア**: 秘密鍵が安全に管理されているか
- [ ] **バリデーション**: 入力値の検証が適切に行われているか

### ネットワーク通信
- [ ] **HTTPS**: すべての通信がHTTPSで行われているか
- [ ] **Certificate Pinning**: 必要に応じて証明書ピニングが実装されているか
- [ ] **タイムアウト**: 適切なタイムアウト設定があるか
- [ ] **リトライロジック**: 適切なリトライ機構があるか

## パフォーマンスレビュー

### メモリ使用量
- [ ] **オブジェクト生成**: 不要なオブジェクト生成がないか
- [ ] **コレクション**: 適切なコレクション型が使用されているか
- [ ] **画像処理**: 大きな画像が適切に処理されているか
- [ ] **キャッシュ**: 適切なキャッシュ戦略が実装されているか

### 処理速度
- [ ] **データベースアクセス**: クエリが最適化されているか
- [ ] **ネットワーク**: 不要な通信が発生していないか
- [ ] **UI更新**: UIの更新が効率的に行われているか
- [ ] **バックグラウンド処理**: 重い処理がバックグラウンドで実行されているか

## プロジェクト固有の重要チェック

### 🚨 絶対禁止ルール（core_principles.md）
- [ ] **コメント言語**: 中国語コメントがないか
- [ ] **Realm管理**: .use{}パターンを使用しているか
- [ ] **null安全**: !!演算子を使用していないか
- [ ] **Import Style**: 完全修飾名を使用していないか（R.drawable等）
- [ ] **依存性注入**: @Injectアノテーションを使用しているか

### Kotlin開発規約
- [ ] **クラス内メソッド順序**: Properties → Override methods → Private methods → Companion object
- [ ] **データクラス**: 適切にdata classを使用しているか
- [ ] **スコープ関数**: let, apply, run等を適切に使用しているか

## レビューコメントのフォーマット

### 重要度レベル
- **🚨 CRITICAL**: ビルドエラーや重大な脆弱性（即座に修正必須）
- **⚠️ MAJOR**: 性能問題やメモリリーク（修正推奨）
- **💡 MINOR**: コードスタイルや命名規則（改善提案）
- **ℹ️ INFO**: 参考情報や推奨事項

### コメント例
```
🚨 CRITICAL: Realmリソース管理
ファイル: UserRepository.kt:45
問題: 手動のrealm.close()を使用
修正: .use{}パターンに変更してください

⚠️ MAJOR: null安全性
ファイル: VideoFragment.kt:120
問題: !!演算子の使用
修正: ?.let {}または適切なnullチェックを使用
```

## レビュー完了後

### レビュー結果サマリー
- **Critical Issues**: X件
- **Major Issues**: X件
- **Minor Issues**: X件
- **総合評価**: PASS/NEEDS_WORK

### 次のステップ
- Critical/Major issuesは修正必須
- Minor issuesは改善推奨
- 修正後に再レビュー
